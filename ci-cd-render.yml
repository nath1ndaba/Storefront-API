name: CI/CD Pipeline - Deploy to Render

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  # Job 1: Build and Test
  build-and-test:
    name: Build & Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ”§ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
    
    - name: ðŸ“¦ Restore dependencies
      run: dotnet restore
    
    - name: ðŸ—ï¸ Build solution
      run: dotnet build --configuration Release --no-restore
    
    - name: âœ… Run tests (if any)
      run: dotnet test --no-build --verbosity normal --configuration Release
      continue-on-error: true
    
    - name: ðŸ“Š Build summary
      run: |
        echo "### âœ… Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- .NET Version: ${{ env.DOTNET_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- Configuration: Release" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # Job 2: Docker Build
  docker-build:
    name: Docker Build & Validate
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: ðŸ³ Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: ðŸ—ï¸ Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        push: false
        tags: storefront-api:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
    
    - name: ðŸ“Š Docker build summary
      run: |
        echo "### ðŸ³ Docker Build Successful!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Image: storefront-api:${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- Platform: linux/amd64" >> $GITHUB_STEP_SUMMARY

  # Job 3: Deploy to Render
  deploy:
    name: Deploy to Render
    runs-on: ubuntu-latest
    needs: [build-and-test, docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ðŸš€ Trigger Render Deployment
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" -X POST ${{ secrets.RENDER_DEPLOY_HOOK_URL }})
        if [ $response -eq 200 ] || [ $response -eq 201 ]; then
          echo "âœ… Deployment triggered successfully!"
        else
          echo "âŒ Deployment trigger failed with status code: $response"
          exit 1
        fi
    
    - name: ðŸ“Š Deployment summary
      run: |
        echo "### ðŸš€ Deployment Triggered!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "Your API will be live in 3-5 minutes at:" >> $GITHUB_STEP_SUMMARY
        echo "**https://storefront-api.onrender.com/swagger**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- Branch: main" >> $GITHUB_STEP_SUMMARY
        echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- Triggered by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
    
    - name: ðŸ’¬ Comment on commit (optional)
      if: github.event_name == 'push'
      run: |
        echo "ðŸš€ Deployment to Render initiated!"
        echo "Check status at: https://dashboard.render.com"

  # Job 4: Post-Deploy Validation
  validate:
    name: Validate Deployment
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
    - name: â³ Wait for deployment
      run: |
        echo "Waiting 90 seconds for Render deployment to complete..."
        sleep 90
    
    - name: ðŸ” Health check
      run: |
        response=$(curl -s -o /dev/null -w "%{http_code}" https://storefront-api.onrender.com/)
        if [ $response -eq 200 ]; then
          echo "âœ… API is responding!"
        else
          echo "âš ï¸ API returned status code: $response"
          echo "Note: First deployment may take longer"
        fi
      continue-on-error: true
    
    - name: ðŸ“Š Validation summary
      run: |
        echo "### âœ… Pipeline Complete!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Your API is deployed!**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [View Swagger UI](https://storefront-api.onrender.com/swagger)" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— [View API](https://storefront-api.onrender.com)" >> $GITHUB_STEP_SUMMARY
